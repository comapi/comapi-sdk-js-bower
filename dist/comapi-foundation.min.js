var COMAPI=function(a){function b(d){if(c[d])return c[d].exports;var e=c[d]={exports:{},id:d,loaded:!1};return a[d].call(e.exports,e,e.exports,b),e.loaded=!0,e.exports}var c={};return b.m=a,b.c=c,b.p="",b(0)}([function(a,b,c){var d=c(1),e=c(2),f=c(3),g=c(4),h=c(5),i=c(6),j=c(7),k=c(8),l=c(10),m=c(11),n=c(12),o=c(13),p=c(14),q=c(15),r=c(16),s=c(17);b.ConversationBuilder=s.ConversationBuilder;var t=c(18);b.MessageBuilder=t.MessageBuilder;var u=c(19);b.MessageStatusBuilder=u.MessageStatusBuilder;var v=c(20),w=c(21),x=c(22);b.ComapiConfig=x.ComapiConfig;var y=c(24),z=c(25),A=c(26),B=c(27),C=c(28),D=c(29),E=c(23),F=function(){function a(a,b,c,d,e,f,g,h,i,j){this._eventManager=a,this._logger=b,this._networkManager=d;var k,l="indexedDB"in window;k=l?new v.IndexedDBOrphanedEventManager:new w.LocalStorageOrphanedEventManager(c);var m=new p.MessagePager(b,c,i,k),n=new y.AppMessaging(this._networkManager,g,i,m),o=new z.Profile(this._networkManager,c,h);this._services=new A.Services(n,o),this._device=new B.Device(this._networkManager,e),this._channels=new C.Channels(this._networkManager,f)}return a.initialiseShared=function(b){return a._initialise(b,!0)},a.initialise=function(b){return a._initialise(b,!1)},Object.defineProperty(a,"version",{get:function(){return"1.0.2.36"},enumerable:!0,configurable:!0}),a._initialise=function(b,c){function p(b,c){var i=new e.EventManager,p=new j.LocalStorageData,s=new f.Logger(i,b.logPersistence===d.LogPersistences.LocalStorage?p:void 0,c);b.logLevel&&(s.logLevel=b.logLevel);var t=new g.RestClient(s),u=new k.SessionManager(s,t,p,b),v=new r.WebSocketManager(s,p,b,u,i),w=new D.NetworkManager(u,v),x=new h.AuthenticatedRestClient(s,w),y=new l.DeviceManager(s,x,p,b),z=new m.FacebookManager(x,b),A=new q.ConversationManager(s,x,p,b,u);return new a(i,s,p,w,y,z,A,new n.ProfileManager(s,x,p,b,u),new o.MessageManager(s,x,p,b,u,A),b)}if(c&&a._foundation)return Promise.resolve(a._foundation);if(void 0===b.foundationRestUrls&&(b.foundationRestUrls=new E.FoundationRestUrls),b.logPersistence&&b.logPersistence===d.LogPersistences.IndexedDB){var s=new i.IndexedDBLogger;return s.openDatabase().then(function(){var a=void 0===b.logRetentionHours?24:b.logRetentionHours,c=new Date((new Date).valueOf()-36e5*a);return s.purge(c)}).then(function(){var d=p(b,s);return c&&(a._foundation=d),Promise.resolve(d)})}var t=p(b);return c&&(a._foundation=t),Promise.resolve(t)},a.prototype.startSession=function(){return this._networkManager.startSession().then(function(a){return a.session})},a.prototype.endSession=function(){return this._networkManager.endSession()},Object.defineProperty(a.prototype,"services",{get:function(){return this._services},enumerable:!0,configurable:!0}),Object.defineProperty(a.prototype,"device",{get:function(){return this._device},enumerable:!0,configurable:!0}),Object.defineProperty(a.prototype,"channels",{get:function(){return this._channels},enumerable:!0,configurable:!0}),Object.defineProperty(a.prototype,"session",{get:function(){return this._networkManager.session},enumerable:!0,configurable:!0}),Object.defineProperty(a.prototype,"logger",{get:function(){return this._logger},enumerable:!0,configurable:!0}),a.prototype.on=function(a,b){this._eventManager.subscribeToLocalEvent(a,b)},a.prototype.off=function(a,b){this._eventManager.unsubscribeFromLocalEvent(a,b)},a.prototype.getLogs=function(){return this._logger.getLog()},a}();b.Foundation=F},function(a,b){!function(a){a[a.None=0]="None",a[a.Error=1]="Error",a[a.Warn=2]="Warn",a[a.Debug=3]="Debug"}(b.LogLevels||(b.LogLevels={}));b.LogLevels;!function(a){a[a.None=0]="None",a[a.IndexedDB=1]="IndexedDB",a[a.LocalStorage=2]="LocalStorage"}(b.LogPersistences||(b.LogPersistences={}));b.LogPersistences;!function(a){a[a.development=0]="development",a[a.production=1]="production"}(b.Environment||(b.Environment={}));b.Environment;!function(a){a[a.public=0]="public",a[a.participant=1]="participant"}(b.ConversationScope||(b.ConversationScope={}));b.ConversationScope},function(a,b){var c=function(){function a(){this.eventSubscribers=[]}return a.prototype.subscribeToLocalEvent=function(a,b){this.eventSubscribers.push({eventType:a,handler:b})},a.prototype.isSubscribedToLocalEvent=function(a){for(var b=!1,c=0,d=this.eventSubscribers;c<d.length;c++){if(d[c].eventType===a){b=!0;break}}return b},a.prototype.unsubscribeFromLocalEvent=function(a,b){for(var c=this.eventSubscribers.length-1;c>=0;c--){var d=this.eventSubscribers[c];b&&d.handler===b&&d.eventType===a?this.eventSubscribers.splice(c,1):d.eventType===a&&this.eventSubscribers.splice(c,1)}},a.prototype.publishLocalEvent=function(a,b){var c=this;setTimeout(function(){for(var d=0,e=c.eventSubscribers;d<e.length;d++){var f=e[d];f.eventType===a&&f.handler(b)}})},a}();b.EventManager=c},function(a,b,c){var d=c(1),e=function(){function a(a,b,c){this._eventManager=a,this._localStorageData=b,this._indexedDB=c,this._logLevel=d.LogLevels.Debug,this._uid=("0000"+(Math.random()*Math.pow(36,4)<<0).toString(36)).slice(-4),this._maxLocalStorageLogSize=1024,this._localStorageKey="rollingLogfile"}return Object.defineProperty(a.prototype,"logLevel",{get:function(){return this._logLevel},set:function(a){this._logLevel=a},enumerable:!0,configurable:!0}),a.prototype.log=function(a,b){return this._log(d.LogLevels.Debug,a,b)},a.prototype.warn=function(a,b){return this._log(d.LogLevels.Warn,a,b)},a.prototype.error=function(a,b){return this._log(d.LogLevels.Error,a,b)},a.prototype.getLog=function(){var a=this;return new Promise(function(b,c){a._indexedDB?a._indexedDB.getData().then(function(a){b(JSON.stringify(a))}).catch(function(a){c(a)}):a._localStorageData?b(a._localStorageData.getString(a._localStorageKey)):c({message:"No logfile to get"})})},a.prototype.clearLog=function(){var a=this;return new Promise(function(b,c){a._indexedDB?a._indexedDB.clearData().then(function(){b(!0)}).catch(function(a){c(a)}):a._localStorageData?(a._localStorageData.remove(a._localStorageKey),b(!0)):c({message:"No logfile to clear"})})},a.prototype._stringForLogLevel=function(a){switch(a){case d.LogLevels.Debug:return"Debug";case d.LogLevels.Warn:return"Warning";case d.LogLevels.Error:return"Error";default:return"?"}},a.prototype._log=function(a,b,c){var e=this;return new Promise(function(f,g){if(a<=e._logLevel){var h="["+e._uid+"] : "+(new Date).toJSON()+" ["+e._stringForLogLevel(a)+"] : "+b+(void 0!==c?" : "+JSON.stringify(c):"")+"\r\n";switch(a){case d.LogLevels.Error:console.error(h);break;case d.LogLevels.Warn:console.warn(h);break;case d.LogLevels.Debug:console.log(h)}var i=new Date,j={created:i.valueOf(),data:c,logLevel:a,message:b,timestamp:i.toISOString()};if(e._indexedDB)e._indexedDB.addRecord(j).then(function(a){f(!0)});else if(e._localStorageData){var k=e._localStorageData.getString(e._localStorageKey);null!==k?k+=h:k=h,k.length>e._maxLocalStorageLogSize&&(k=k.substring(h.length)),e._localStorageData.setString(e._localStorageKey,k),f(!0)}else f(!0);e._eventManager&&e._eventManager.publishLocalEvent("LogMessage",j)}})},a}();b.Logger=e},function(a,b){var c=function(){function a(a,b){this.logger=a,this.networkManager=b,this._readyStates=["request not initialized","server connection established","request received ","processing request","request finished and response is ready"]}return a.prototype.get=function(a,b){return this.makeRequest("GET",a,b)},a.prototype.post=function(a,b,c){return this.makeRequest("POST",a,b,c)},a.prototype.put=function(a,b,c){return this.makeRequest("PUT",a,b,c)},a.prototype.patch=function(a,b,c){return this.makeRequest("PATCH",a,b,c)},a.prototype.delete=function(a,b){return this.makeRequest("DELETE",a,b)},a.prototype.addHeaders=function(a,b){for(var c in b)b.hasOwnProperty(c)&&a.setRequestHeader(c,b[c])},a.prototype.getResponseHeaders=function(a){var b={},c=a.getAllResponseHeaders();if(c)for(var d=c.split("\r\n"),e=0;e<d.length;e++){var f=d[e],g=f.indexOf(": ");if(g>0){var h=f.substring(0,g),i=f.substring(g+2);b[h]=i}}return b},a.prototype.createCORSRequest=function(a,b){var c=new XMLHttpRequest;return"withCredentials"in c&&c.open(a,b,!0),c},a.prototype._makeRequest=function(a,b,c,d){var e=this;return new Promise(function(f,g){e.logger&&e.logger.log(a+"'ing "+b+"  ...");var h=e.createCORSRequest(a,b);e.logger&&e.logger.log("Created XMLHttpRequest ..."),void 0!==c&&e.addHeaders(h,c),e.logger&&e.logger.log("added headers",c),h.onload=function(){e.logger&&e.logger.log("xhr.onload",h.responseText);var c=h.status>=200&&h.status<300,d={headers:e.getResponseHeaders(h),response:void 0,statusCode:h.status};if(h.responseText)try{d.response=JSON.parse(h.responseText),e.logger&&e.logger.log(a+"'ing to "+b+" returned this object: ",d.response)}catch(c){d.response=h.responseText,e.logger&&e.logger.log(a+"'ing to "+b+" returned this text: "+h.responseText)}c?f(d):g(d)},h.onerror=function(){e.logger&&e.logger.log("xhr.onerror",h.responseText),e.logger&&e.logger.error(a+"'ing to "+b+" failed");var c={headers:e.getResponseHeaders(h),response:h.responseText,statusCode:h.status};g(c)},h.onreadystatechange=function(a){e.logger&&e.logger.log("onreadystatechange: "+e._readyStates[h.readyState]+" [status="+h.status+"]")},h.onabort=function(a){e.logger&&e.logger.log("onabort",a)},h.send(d?JSON.stringify(d):null),e.logger&&e.logger.log("send data",d)})},a.prototype.makeRequest=function(a,b,c,d){function e(g){return f._makeRequest(a,b,c,d).catch(function(a){if(g<3&&401===a.statusCode&&f.networkManager)return f.networkManager.restartSession().then(function(a){return c.authorization="Bearer "+a.token,e(++g)});throw a})}var f=this;return c=c||{},c["Content-Type"]||(c["Content-Type"]="application/json"),c["Cache-Control"]||(c["Cache-Control"]="no-cache"),e(0)},a}();b.RestClient=c},function(a,b,c){var d=this&&this.__extends||function(a,b){function c(){this.constructor=a}for(var d in b)b.hasOwnProperty(d)&&(a[d]=b[d]);a.prototype=null===b?Object.create(b):(c.prototype=b.prototype,new c)},e=c(4),f=function(a){function b(b,c){a.call(this,b,c)}return d(b,a),b.prototype.get=function(b,c){var d=this;return c=c||{},this.networkManager.getValidToken().then(function(e){return c.authorization=d.constructAUthHeader(e),a.prototype.get.call(d,b,c)})},b.prototype.post=function(b,c,d){var e=this;return this.networkManager.getValidToken().then(function(f){return c.authorization=e.constructAUthHeader(f),a.prototype.post.call(e,b,c,d)})},b.prototype.patch=function(b,c,d){var e=this;return this.networkManager.getValidToken().then(function(f){return c.authorization=e.constructAUthHeader(f),a.prototype.patch.call(e,b,c,d)})},b.prototype.put=function(b,c,d){var e=this;return this.networkManager.getValidToken().then(function(f){return c.authorization=e.constructAUthHeader(f),a.prototype.put.call(e,b,c,d)})},b.prototype.delete=function(b,c){var d=this;return this.networkManager.getValidToken().then(function(e){return c.authorization=d.constructAUthHeader(e),a.prototype.delete.call(d,b,c)})},b.prototype.constructAUthHeader=function(a){return"Bearer "+a},b}(e.RestClient);b.AuthenticatedRestClient=f},function(a,b){var c=function(){function a(a){this.idbSupported="indexedDB"in window,this._name="Comapi",this._version=1,this._store="Logs",a&&(this._name=a)}return a.prototype.openDatabase=function(){var a=this;return new Promise(function(b,c){if(a.idbSupported){var d=a,e=indexedDB.open(a._name,a._version);e.onupgradeneeded=function(a){console.log("Upgrading database...");var b=a.target.result;if(!b.objectStoreNames.contains(d._store)){b.createObjectStore(d._store,{autoIncrement:!0}).createIndex("created","created",{unique:!1})}},e.onsuccess=function(a){d._database=a.target.result,b(!0)},e.onerror=function(a){c({message:"IndexedDBLogger.open failed : "+a.target.error.name})}}else c({message:"IndexedDBLogger not supported on this platform"})})},a.prototype.purge=function(a){var b=this;return new Promise(function(c,d){if(b._database){var e=b._database.transaction([b._store],"readwrite"),f=e.objectStore(b._store),g=f.index("created"),h=IDBKeyRange.upperBound(a.valueOf());g.openCursor(h).onsuccess=function(a){var b=a.target.result;b?(f.delete(b.primaryKey),b.continue()):c(!0)}}else d({message:"Database not open"})})},a.prototype.deleteDatabase=function(){var a=this;return new Promise(function(b,c){var d=indexedDB.deleteDatabase(a._name),e=a;d.onsuccess=function(){console.log("Deleted database "+e._name+" successfully"),b(!0)},d.onerror=function(a){c({message:"Couldn't delete database "+e._name+" : "+a.target.error.name})},d.onblocked=function(){console.warn("Couldn't delete database "+e._name+" due to the operation being blocked")}})},a.prototype.clearData=function(){var a=this;return new Promise(function(b,c){if(a._database){var d=a._database.transaction([a._store],"readwrite");d.onerror=function(a){console.error("Transaction not opened due to error: "+d.error)};var e=d.objectStore(a._store),f=e.clear();f.onsuccess=function(a){b(!0)},f.onerror=function(a){c({message:"Failed to clear object store: "+a.target.error.name})}}else c({message:"Database not open"})})},a.prototype.getData=function(a,b){var c=this;return new Promise(function(d,e){if(c._database){var f=c._database.transaction([c._store],"readonly"),g=f.objectStore(c._store),h=g.openCursor(),i=0,j=[];h.onsuccess=function(c){var e=c.target.result;if(i++,e){var f=e.value;b===!0&&(f.key=e.key),j.push(e.value),i&&i>=a?d(j):e.continue()}else d(j)},h.onerror=function(a){e({message:"Failed to openCursor: "+a.target.error.name})}}else e({message:"Database not open"})})},a.prototype.getCount=function(){var a=this;return new Promise(function(b,c){if(a._database){var d=a._database.transaction([a._store],"readonly"),e=d.objectStore(a._store),f=e.count();f.onerror=function(a){c({message:"Failed to get count: "+a.target.error.name})},f.onsuccess=function(){b(f.result)}}else c({message:"Database not open"})})},a.prototype.closeDatabase=function(){this._database&&this._database.close()},a.prototype.addRecord=function(a){var b=this;return new Promise(function(c,d){if(b._database){var e=b._database.transaction([b._store],"readwrite"),f=e.objectStore(b._store),g=f.add(a);g.onerror=function(a){console.error("Error",a.target.error.name),d({message:"add failed: "+a.target.error.name})},g.onsuccess=function(a){c(a.target.result)}}else d({message:"Database not open"})})},a}();b.IndexedDBLogger=c},function(a,b){var c=function(){function a(a){this._prefix="comapi.",a&&(this._prefix=a)}return a.prototype.getString=function(a){return localStorage.getItem(this._prefix+a)},a.prototype.setString=function(a,b){localStorage.setItem(this._prefix+a,b)},a.prototype.getObject=function(a){var b=null,c=this.getString(a);try{b=JSON.parse(c)}catch(b){console.error("caught exception in LocalStorageData.get("+a+"): "+b)}return b},a.prototype.setObject=function(a,b){var c=!0;try{var d=JSON.stringify(b);this.setString(a,d)}catch(b){console.log("caught exception in LocalStorageData.set("+a+"): "+b),c=!1}return c},a.prototype.remove=function(a){try{localStorage.removeItem(this._prefix+a)}catch(b){console.error("caught exception in LocalStorageData.remove("+a+"): "+b)}},a}();b.LocalStorageData=c},function(a,b,c){var d=c(9),e=function(){function a(a,b,c,e){this._logger=a,this._restClient=b,this._localStorageData=c,this._comapiConfig=e,this._deviceId=c.getString("deviceId"),this._deviceId||(this._deviceId=d.Utils.uuid(),c.setString("deviceId",this._deviceId)),this._getSession()}return Object.defineProperty(a.prototype,"sessionInfo",{get:function(){return this._sessionInfo},enumerable:!0,configurable:!0}),Object.defineProperty(a.prototype,"expiry",{get:function(){return this._sessionInfo.session.expiresOn},enumerable:!0,configurable:!0}),Object.defineProperty(a.prototype,"isActive",{get:function(){var a=!1;if(this._sessionInfo){new Date<new Date(this._sessionInfo.session.expiresOn)?a=!0:this._removeSession()}return a},enumerable:!0,configurable:!0}),a.prototype.getValidToken=function(){return this.isActive?Promise.resolve(this._sessionInfo.token):this.startSession().then(function(a){return Promise.resolve(a.token)})},a.prototype.startSession=function(){var a=this,b=this;return new Promise(function(c,d){a.isActive?(b._logger.log("startSession() found an existing session: "),c(a._getSession())):a._startAuth().then(function(a){var e={nonce:a.nonce};b._comapiConfig.authChallenge(e,function(e){e?b._createAuthenticatedSession(e,a.authenticationId,{}).then(function(a){b._setSession(a),c(a)}).catch(function(a){d(a)}):d({message:"Failed to get a JWT from authChallenge",statusCode:401})})}).catch(function(a){return d(a)})})},a.prototype.endSession=function(){var a=this;return new Promise(function(b,c){a._sessionInfo?a._endAuth().then(function(c){a._removeSession(),b(!0)}).catch(function(b){a._removeSession(),c(b)}):c({message:"No active session is present, create one before ending one"})})},a.prototype._createAuthenticatedSession=function(a,b,c){var e=d.Utils.getBrowserInfo(),f={authenticationId:b,authenticationToken:a,deviceId:this._deviceId,platform:"javascript",platformVersion:e.version,sdkType:"native",sdkVersion:"1.0.2.36"},g=d.Utils.format(this._comapiConfig.foundationRestUrls.sessions,{apiSpaceId:this._comapiConfig.apiSpaceId,urlBase:this._comapiConfig.urlBase});return this._restClient.post(g,{},f).then(function(a){return Promise.resolve(a.response)})},a.prototype._startAuth=function(){var a=d.Utils.format(this._comapiConfig.foundationRestUrls.sessionStart,{apiSpaceId:this._comapiConfig.apiSpaceId,urlBase:this._comapiConfig.urlBase});return this._restClient.get(a).then(function(a){return Promise.resolve(a.response)})},a.prototype._endAuth=function(){var a={"Content-Type":"application/json",authorization:this.getAuthHeader()},b=d.Utils.format(this._comapiConfig.foundationRestUrls.session,{apiSpaceId:this._comapiConfig.apiSpaceId,urlBase:this._comapiConfig.urlBase});return this._restClient.delete(b,a).then(function(a){return Promise.resolve(!0)})},a.prototype._getSession=function(){var a=this._localStorageData.getObject("session");return a&&(this._sessionInfo=a),a},a.prototype._setSession=function(a){new Date(a.session.expiresOn)<new Date&&this._logger.error("Was given an expired token ;-("),this._sessionInfo=a,this._localStorageData.setObject("session",a)},a.prototype._removeSession=function(){this._localStorageData.remove("session"),this._sessionInfo=void 0},a.prototype.getAuthHeader=function(){return"Bearer "+this.sessionInfo.token},a}();b.SessionManager=e},function(a,b){var c=function(){function a(){throw new Error("Cannot new this class")}return a.clone=function(a){return JSON.parse(JSON.stringify(a))},a.uuid=function(){var a=(new Date).getTime();return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(b){var c=(a+16*Math.random())%16|0;return a=Math.floor(a/16),("x"===b?c:3&c|8).toString(16)})},a.getBrowserInfo=function(a){var b,c=void 0!==a?a:navigator.userAgent,d=c.match(/(opera|chrome|safari|firefox|msie|trident(?=\/))\/?\s*(\d+)/i)||[];return/trident/i.test(d[1])?(b=/\brv[ :]+(\d+)/g.exec(c)||[],{name:"IE",version:b[1]||""}):"Chrome"===d[1]&&null!==(b=c.match(/\bOPR\/(\d+)/))?{name:"Opera",version:b[1]}:(d=d[2]?[d[1],d[2]]:[navigator.appName,navigator.appVersion,"-?"],b=c.match(/version\/(\d+)/i),null!==b&&d.splice(1,1,b[1]),{name:d[0],version:d[1]})},a.eachSeries=function(a,b){return a.reduce(function(a,c){return a.then(function(){return b(c)})},Promise.resolve())},a.doUntil=function(b,c,d){return b(d).then(function(d){return c(d)?a.doUntil(b,c,d):d})},a.format=function(a,b){return a.replace(/{{(.*?)}}/g,function(a,c){var d=!1;return"string"==typeof b[c]&&(d=b[c]),"string"==typeof d?d:a})},a}();b.Utils=c},function(a,b,c){var d=c(1),e=c(9),f=function(){function a(a,b,c,d){this._logger=a,this._restClient=b,this._localStorageData=c,this._comapiConfig=d}return a.prototype.setFCMPushDetails=function(a,b,c){var d={fcm:{package:b,registrationId:c}};return this._restClient.put(this.getPushUrl(a),{},d).then(function(a){return Promise.resolve(!0)})},a.prototype.setAPNSPushDetails=function(a,b,c,e){var f={apns:{bundleId:b,environment:d.Environment[c],token:e}};return this._restClient.put(this.getPushUrl(a),{},f).then(function(a){return Promise.resolve(!0)})},a.prototype.removePushDetails=function(a){return this._restClient.delete(this.getPushUrl(a),{}).then(function(a){return Promise.resolve(!0)})},a.prototype.getPushUrl=function(a){return e.Utils.format(this._comapiConfig.foundationRestUrls.push,{apiSpaceId:this._comapiConfig.apiSpaceId,sessionId:a,urlBase:this._comapiConfig.urlBase})},a}();b.DeviceManager=f},function(a,b,c){var d=c(9),e=function(){function a(a,b){this._restClient=a,this._comapiConfig=b}return a.prototype.createSendToMessengerState=function(a){var b=d.Utils.format(this._comapiConfig.foundationRestUrls.facebook,{apiSpaceId:this._comapiConfig.apiSpaceId,urlBase:this._comapiConfig.urlBase});return this._restClient.post(b,{},a||{})},a}();b.FacebookManager=e},function(a,b,c){var d=c(9),e=function(){function a(a,b,c,d,e){this._logger=a,this._restClient=b,this._localStorageData=c,this._comapiConfig=d,this._sessionManager=e}return a.prototype.getProfile=function(a){var b=d.Utils.format(this._comapiConfig.foundationRestUrls.profile,{apiSpaceId:this._comapiConfig.apiSpaceId,profileId:a,urlBase:this._comapiConfig.urlBase});return this._restClient.get(b)},a.prototype.queryProfiles=function(a){var b=d.Utils.format(this._comapiConfig.foundationRestUrls.profiles,{apiSpaceId:this._comapiConfig.apiSpaceId,urlBase:this._comapiConfig.urlBase});return a&&(b+="?"+a),this._restClient.get(b)},a.prototype.updateProfile=function(a,b,c){var e={};c&&(e["If-Match"]=c);var f=d.Utils.clone(b);void 0===f.id&&(f.id=a);var g=d.Utils.format(this._comapiConfig.foundationRestUrls.profile,{apiSpaceId:this._comapiConfig.apiSpaceId,profileId:a,urlBase:this._comapiConfig.urlBase});return this._restClient.put(g,e,f)},a.prototype.patchProfile=function(a,b,c){var e={};c&&(e["If-Match"]=c);var f=d.Utils.clone(b);void 0===f.id&&(f.id=a);var g=d.Utils.format(this._comapiConfig.foundationRestUrls.profile,{apiSpaceId:this._comapiConfig.apiSpaceId,profileId:a,urlBase:this._comapiConfig.urlBase});return this._restClient.patch(g,e,f)},a}();b.ProfileManager=e},function(a,b,c){var d=c(9),e=function(){function a(a,b,c,d,e,f){this._logger=a,this._restClient=b,this._localStorageData=c,this._comapiConfig=d,this._sessionManager=e,this._conversationManager=f}return a.prototype.getConversationEvents=function(a,b,c){var e=d.Utils.format(this._comapiConfig.foundationRestUrls.events,{apiSpaceId:this._comapiConfig.apiSpaceId,conversationId:a,urlBase:this._comapiConfig.urlBase});return e+="?from="+b,e+="&limit="+c,this._restClient.get(e).then(function(a){return Promise.resolve(a.response)})},a.prototype.getConversationMessages=function(a,b,c){var e=d.Utils.format(this._comapiConfig.foundationRestUrls.messages,{apiSpaceId:this._comapiConfig.apiSpaceId,conversationId:a,urlBase:this._comapiConfig.urlBase});return e+="?limit="+b,void 0!==c&&(e+="&from="+c),this._restClient.get(e).then(function(a){return Promise.resolve(a.response)})},a.prototype._sendMessageToConversation=function(a,b,c,e){var f={alert:e,metadata:b,parts:c},g=d.Utils.format(this._comapiConfig.foundationRestUrls.messages,{apiSpaceId:this._comapiConfig.apiSpaceId,conversationId:a,urlBase:this._comapiConfig.urlBase});return this._restClient.post(g,{},f).then(function(a){return Promise.resolve(a.response)})},a.prototype.sendMessageToConversation=function(a,b){var c=d.Utils.format(this._comapiConfig.foundationRestUrls.messages,{apiSpaceId:this._comapiConfig.apiSpaceId,conversationId:a,urlBase:this._comapiConfig.urlBase});return this._restClient.post(c,{},b).then(function(a){return Promise.resolve(a.response)})},a.prototype.sendMessageStatusUpdates=function(a,b){var c={"Content-Type":"application/json"},e=d.Utils.format(this._comapiConfig.foundationRestUrls.statusUpdates,{apiSpaceId:this._comapiConfig.apiSpaceId,conversationId:a,urlBase:this._comapiConfig.urlBase});return this._restClient.post(e,c,b).then(function(a){return Promise.resolve(a.response)})},a}();b.MessageManager=e},function(a,b,c){var d=c(9),e=function(){function a(a,b,c,d){this._logger=a,this._localStorage=b,this._messageManager=c,this._orphanedEventManager=d}return a.prototype.getMessages=function(a,b,c){var d=this;if(c<=0)return Promise.reject({message:"All messages from conversation "+a+" have been loaded"});var e,f=null;return this._orphanedEventManager.getContinuationToken(a).then(function(b){return f=b,void 0!==c?f!==c?Promise.reject({message:"Invalid continuation token: "+c+" for "+a+", you nust start from the end"}):Promise.resolve(!0):d._orphanedEventManager.clear(a)}).then(function(){return d._messageManager.getConversationMessages(a,b,c)}).then(function(b){return e=b,void 0===b.messages?(d._logger.log("No messages in this channel yet"),Promise.resolve({messages:[]})):d.getOrphanedEvents(a,e.orphanedEvents).then(function(a){return d.applyOrphanedEvents(e.messages,a)}).then(function(){return f=e.earliestEventId-1,d._orphanedEventManager.setContinuationToken(a,f)}).then(function(){return Promise.resolve({continuationToken:f,earliestEventId:e.earliestEventId,latestEventId:e.latestEventId,messages:e.messages})})})},a.prototype.getOrphanedEvents=function(a,b){var c=this,e=b.map(function(a){return c.mapOrphanedEvent(a)});return d.Utils.eachSeries(e,function(a){return c._orphanedEventManager.addOrphanedEvent(a)}).then(function(b){return c._orphanedEventManager.getOrphanedEvents(a)})},a.prototype.markMessagesAsDelivered=function(a,b,c){for(var d=[],e=0;e<b.length;e++){var f=b[e];if(f.context&&f.context.from&&f.context.from.id!==c){var g=!1;f.statusUpdates&&f.statusUpdates[c]&&("delivered"!==f.statusUpdates[c].status&&"read"!==f.statusUpdates[c].status||(g=!0)),g||d.unshift(f.id)}}if(d.length>0){var h={messageIds:d,status:"delivered",timestamp:(new Date).toISOString()};return this._messageManager.sendMessageStatusUpdates(a,[h])}return Promise.resolve("OK")},a.prototype.resetConversation=function(a){return this._orphanedEventManager.clear(a)},a.prototype.applyOrphanedEvents=function(a,b){var c=this;return d.Utils.eachSeries(b,function(b){return c.playEvent(b,a)?(c._logger.log("succesfuly played event "+b.conversationEventId),c._orphanedEventManager.removeOrphanedEvent(b)):(c._logger.warn("failed to play event "+b.conversationEventId,b),Promise.resolve(!1))})},a.prototype.playEvent=function(a,b){var c,d=!1,e=b.filter(function(b){return b.id===a.payload.messageId});switch(1===e.length?(c=e[0],d=!0):e.length>=1?this._logger.error("Found more than 1 message with same messageId: "+a.payload.messageId):this._logger.log("Message "+a.payload.messageId+" not found ..."),a.name){case"conversationMessage.read":c&&(c.statusUpdates[a.payload.profileId]={status:"read",on:a.payload.timestamp});break;case"conversationMessage.delivered":if(c){var f=c.statusUpdates[a.payload.profileId];f&&"read"===f.status?this._logger.log("Message already marked as read, not marking as delivered"):c.statusUpdates[a.payload.profileId]={status:"delivered",on:a.payload.timestamp}}break;default:this._logger.error("Unknown eventName "+a.name+" for messageId: "+a.payload.messageId)}return d},a.prototype.mapOrphanedEvent=function(a){var b={};return b.conversationEventId=a.id,b.name="conversationMessage."+a.data.name,b.eventId=a.data.eventId,b.conversationId=a.data.payload.conversationId,b.payload=a.data.payload,b},a}();b.MessagePager=e},function(a,b,c){var d=c(1),e=c(9),f=function(){function a(a,b,c,d,e){this._logger=a,this._restClient=b,this._localStorageData=c,this._comapiConfig=d,this._sessionManager=e,this.isTypingInfo={},this.isTypingOffInfo={}}return a.prototype.createConversation=function(a){var b=e.Utils.format(this._comapiConfig.foundationRestUrls.conversations,{apiSpaceId:this._comapiConfig.apiSpaceId,urlBase:this._comapiConfig.urlBase});return this._restClient.post(b,{},a).then(function(a){return a.response._etag=a.headers.ETag,Promise.resolve(a.response)})},a.prototype.updateConversation=function(a,b){var c={};b&&(c["if-match"]=b);var d={description:a.description,isPublic:a.isPublic,name:a.name,roles:a.roles},f=e.Utils.format(this._comapiConfig.foundationRestUrls.conversation,{apiSpaceId:this._comapiConfig.apiSpaceId,conversationId:a.id,urlBase:this._comapiConfig.urlBase});return this._restClient.put(f,c,d).then(function(a){return a.response._etag=a.headers.ETag,Promise.resolve(a.response)})},a.prototype.getConversation=function(a){var b=e.Utils.format(this._comapiConfig.foundationRestUrls.conversation,{apiSpaceId:this._comapiConfig.apiSpaceId,conversationId:a,urlBase:this._comapiConfig.urlBase});return this._restClient.get(b).then(function(a){return a.response._etag=a.headers.ETag,Promise.resolve(a.response)})},a.prototype.deleteConversation=function(a){var b=e.Utils.format(this._comapiConfig.foundationRestUrls.conversation,{apiSpaceId:this._comapiConfig.apiSpaceId,conversationId:a,urlBase:this._comapiConfig.urlBase});return this._restClient.delete(b,{}).then(function(a){return Promise.resolve(!0)})},a.prototype.addParticipantsToConversation=function(a,b){var c=e.Utils.format(this._comapiConfig.foundationRestUrls.participants,{apiSpaceId:this._comapiConfig.apiSpaceId,conversationId:a,urlBase:this._comapiConfig.urlBase});return this._restClient.post(c,{},b).then(function(a){return Promise.resolve(!0)})},a.prototype.deleteParticipantsFromConversation=function(a,b){for(var c="",d=0;d<b.length;d++)c+=0===d?"?id="+b[d]:"&id="+b[d];var f=e.Utils.format(this._comapiConfig.foundationRestUrls.participants,{apiSpaceId:this._comapiConfig.apiSpaceId,conversationId:a,urlBase:this._comapiConfig.urlBase});return this._restClient.delete(f+c,{}).then(function(a){return Promise.resolve(!0)})},a.prototype.getParticipantsInConversation=function(a){var b=e.Utils.format(this._comapiConfig.foundationRestUrls.participants,{apiSpaceId:this._comapiConfig.apiSpaceId,conversationId:a,urlBase:this._comapiConfig.urlBase});return this._restClient.get(b).then(function(a){return Promise.resolve(a.response)})},a.prototype.getConversations=function(a,b){var c=e.Utils.format(this._comapiConfig.foundationRestUrls.conversations,{apiSpaceId:this._comapiConfig.apiSpaceId,urlBase:this._comapiConfig.urlBase});return(a||b)&&(c+="?",void 0!==a&&(c+="scope="+d.ConversationScope[a]+"&"),void 0!==b&&(c+="profileId="+b)),this._restClient.get(c).then(function(a){return Promise.resolve(a.response)})},a.prototype.sendIsTyping=function(a){var b=this;if(this.isTypingInfo[a]){var c=new Date(this.isTypingInfo[a]);if(((new Date).getTime()-c.getTime())/1e3<(this._comapiConfig.isTypingTimeout||10))return Promise.resolve(!1)}var d=e.Utils.format(this._comapiConfig.foundationRestUrls.typing,{apiSpaceId:this._comapiConfig.apiSpaceId,conversationId:a,urlBase:this._comapiConfig.urlBase});return this._restClient.post(d,{},{}).then(function(c){return b.isTypingInfo[a]=(new Date).toISOString(),Promise.resolve(!0)})},a.prototype.sendIsTypingOff=function(a){var b=this;if(this.isTypingOffInfo[a]){var c=new Date(this.isTypingOffInfo[a]);if(((new Date).getTime()-c.getTime())/1e3<(this._comapiConfig.isTypingOffTimeout||10))return Promise.resolve(!1)}var d=e.Utils.format(this._comapiConfig.foundationRestUrls.typing,{apiSpaceId:this._comapiConfig.apiSpaceId,conversationId:a,urlBase:this._comapiConfig.urlBase});return this._restClient.delete(d,{}).then(function(c){return b.isTypingOffInfo[a]=(new Date).toISOString(),Promise.resolve(!0)})},a}();b.ConversationManager=f},function(a,b){var c=function(){function a(a,b,c,d,e){this._logger=a,this._localStorageData=b,this._comapiConfig=c,this._sessionManager=d,this._eventManager=e,this.readystates=["Connecting","Open","Closing","Closed"],this.manuallyClosed=!1,this.connected=!1,this.didConnect=!1,this.attempts=1,this.echoIntervalTimeout=18e4}return a.prototype.connect=function(){var a=this;return this._logger.log("WebSocketManager.connect();"),new Promise(function(b,c){
a.webSocket?a.didConnect?b(!0):c():(a._logger.log("WebSocketManager.connect()"),a._sessionManager.getValidToken().then(function(d){a._logger.log("WebSocketManager.connect() - got auth token",d),a.manuallyClosed=!1;var e=a._comapiConfig.webSocketBase+"/apispaces/"+a._comapiConfig.apiSpaceId+"/socket",f="?token="+d,g=e+f;a._logger.log("connecting ...",g),a.webSocket=new WebSocket(g),a.echoIntervalId=setInterval(function(){return a.echo()},a.echoIntervalTimeout),a.webSocket.onopen=function(){a._logger.log("websocket onopen"),a.connected=!0,a.didConnect===!1&&(a.didConnect=!0,a._logger.log("resolving connect() promise"),b(!0))},a.webSocket.onerror=function(b){a._logger.log("websocket onerror - readystate: "+a.readystates[a.webSocket.readyState])},a.webSocket.onmessage=function(b){var c;try{c=JSON.parse(b.data)}catch(c){a._logger.error("socket onmessage: (not JSON)",b.data)}c&&(a._logger.log("websocket onmessage: ",c),a.publishWebsocketEvent(c))},a.webSocket.onclose=function(){if(a.connected=!1,a.webSocket=void 0,a._logger.log("WebSocket Connection closed."),a.didConnect===!1&&c(),!a.manuallyClosed&&a.didConnect){a._logger.log("socket not manually closed, reconnecting ...");var b=a.generateInterval(a.attempts);setTimeout(function(){a.attempts++,a._logger.log("reconnecting ..."),a.connect()},b)}}}))})},a.prototype.send=function(a){this.webSocket&&this.webSocket.send(JSON.stringify(a))},a.prototype.isConnected=function(){return this.didConnect},a.prototype.hasSocket=function(){return!!this.webSocket},a.prototype.disconnect=function(){var a=this;return this._logger.log("WebSocketManager.disconnect();"),new Promise(function(b,c){a.webSocket?(a.webSocket.onclose=function(){a.connected=!1,a.didConnect=!1,a._logger.log("socket closed."),a.webSocket=void 0,b(!0)},clearInterval(a.echoIntervalId),a.manuallyClosed=!0,a.webSocket.close()):b(!1)})},a.prototype.generateInterval=function(a){var b=1e3*(Math.pow(2,a)-1);b>3e4&&(b=3e4);var c=Math.random()*b;return this._logger.log("generateInterval() => "+c),c},a.prototype.echo=function(){this.connected&&this.send({name:"echo",payload:{},publishedOn:(new Date).toISOString()})},a.prototype.publishWebsocketEvent=function(a){switch(a.name){case"conversation.delete":var b={conversationId:a.conversationId,createdBy:a.context.createdBy,timestamp:a.publishedOn};this._eventManager.publishLocalEvent("conversationDeleted",b);break;case"conversation.undelete":var c={conversationId:a.conversationId,createdBy:a.context.createdBy,timestamp:a.publishedOn};this._eventManager.publishLocalEvent("conversationUndeleted",c);break;case"conversation.update":var d={conversationId:a.conversationId,createdBy:a.context.createdBy,description:a.payload.description,eTag:a.etag,isPublic:a.payload.isPublic,name:a.payload.name,roles:a.payload.roles,timestamp:a.publishedOn};this._eventManager.publishLocalEvent("conversationUpdated",d);break;case"conversation.participantAdded":var e={conversationId:a.conversationId,createdBy:a.context.createdBy,profileId:a.payload.profileId,role:a.payload.role,timestamp:a.publishedOn};this._eventManager.publishLocalEvent("participantAdded",e);break;case"conversation.participantRemoved":var f={conversationId:a.conversationId,createdBy:a.context.createdBy,profileId:a.payload.profileId,timestamp:a.publishedOn};this._eventManager.publishLocalEvent("participantRemoved",f);break;case"conversation.participantTyping":var g={conversationId:a.payload.conversationId,createdBy:a.context.createdBy,profileId:a.payload.profileId,timestamp:a.publishedOn};this._eventManager.publishLocalEvent("participantTyping",g);break;case"conversation.participantTypingOff":var h={conversationId:a.payload.conversationId,createdBy:a.context.createdBy,profileId:a.payload.profileId,timestamp:a.publishedOn};this._eventManager.publishLocalEvent("participantTypingOff",h);break;case"conversationMessage.sent":var i={conversationEventId:a.conversationEventId,conversationId:a.payload.context.conversationId,eventId:a.eventId,name:"conversationMessage.sent",payload:{alert:a.payload.alert,context:a.payload.context,messageId:a.payload.messageId,metadata:a.payload.metadata,parts:a.payload.parts}};this._eventManager.publishLocalEvent("conversationMessageEvent",i);break;case"conversationMessage.read":var i={conversationEventId:a.conversationEventId,conversationId:a.payload.conversationId,eventId:a.eventId,name:"conversationMessage.read",payload:{conversationId:a.payload.conversationId,messageId:a.payload.messageId,profileId:a.payload.profileId,timestamp:a.payload.timestamp}};this._eventManager.publishLocalEvent("conversationMessageEvent",i);break;case"conversationMessage.delivered":var i={conversationEventId:a.conversationEventId,conversationId:a.payload.conversationId,eventId:a.eventId,name:"conversationMessage.delivered",payload:{conversationId:a.payload.conversationId,messageId:a.payload.messageId,profileId:a.payload.profileId,timestamp:a.payload.timestamp}};this._eventManager.publishLocalEvent("conversationMessageEvent",i);break;case"profile.update":var i={eTag:a.eTag,profile:a.payload};a.eTag&&this._localStorageData.setString("MyProfileETag",a.eTag),this._eventManager.publishLocalEvent("profileUpdated",i);break;default:this._logger.warn("Unknown Event",a),this._eventManager.publishLocalEvent("webSocketEvent",a)}},a}();b.WebSocketManager=c},function(a,b,c){var d=c(9),e=function(){function a(){this.description=void 0,this.roles={owner:{canSend:!0,canAddParticipants:!0,canRemoveParticipants:!0},participant:{canSend:!0,canAddParticipants:!0,canRemoveParticipants:!0}},this.isPublic=!1,this.participants=void 0,this.id=d.Utils.uuid()}return a.prototype.withId=function(a){return this.id=a,this},a.prototype.withName=function(a){return this.name=a,this},a.prototype.withDescription=function(a){return this.description=a,this},a.prototype.withUsers=function(a){this.participants=[];for(var b=0;b<a.length;b++){var c=a[b];this.participants.push({id:c})}return this},a.prototype.withUser=function(a){return this.participants=[{id:a}],this},a.prototype.withParticipants=function(a){return this.participants=a,this},a.prototype.withOwnerPrivelages=function(a){return this.roles.owner=a,this},a.prototype.withParticipantPrivelages=function(a){return this.roles.participant=a,this},a}();b.ConversationBuilder=e},function(a,b){var c=function(){function a(){this.id=void 0,this.metadata={},this.parts=[],this.alert=void 0,this.context=void 0,this.sentEventId=void 0,this.statusUpdates=void 0}return a.prototype.withText=function(a){return this.parts.push({data:a,size:a.length,type:"text/plain"}),this},a.prototype.withData=function(a,b){return this.parts.push({data:b,size:b.length,type:a}),this},a.prototype.withPart=function(a){return this.parts.push(a),this},a.prototype.withPush=function(a){return this.alert={text:a,platforms:{apns:void 0,fcm:void 0}},this},a.prototype.withApnsAlert=function(a){return this.alert.platforms.apns=a,this},a.prototype.withFcmAlert=function(a){return this.alert.platforms.fcm=a,this},a.prototype.withMetadata=function(a){return this.metadata=a,this},a}();b.MessageBuilder=c},function(a,b){var c=function(){function a(){}return a.prototype.deliveredStatusUpdate=function(a){return{messageIds:[a],status:"delivered",timestamp:(new Date).toISOString()}},a.prototype.deliveredStatusUpdates=function(a){return{messageIds:a,status:"delivered",timestamp:(new Date).toISOString()}},a.prototype.readStatusUpdate=function(a){return{messageIds:[a],status:"read",timestamp:(new Date).toISOString()}},a.prototype.readStatusUpdates=function(a){return{messageIds:a,status:"read",timestamp:(new Date).toISOString()}},a}();b.MessageStatusBuilder=c},function(a,b){var c=function(){function a(){this.idbSupported="indexedDB"in window,this._name="Comapi.OrphanedEvents",this._version=1,this._continuationTokenStore="ContinuationTokens",this._orphanedEventStore="OrphanedEvents"}return a.prototype.clearAll=function(){var a=this;return this.ensureInitialised().then(function(b){return a.clearObjectStore(a._continuationTokenStore)}).then(function(b){return a.clearObjectStore(a._orphanedEventStore)})},a.prototype.clear=function(a){var b=this;return this.ensureInitialised().then(function(c){return b.deleteTokenInfo(a)}).then(function(c){return b.deleteEvents(a)})},a.prototype.getContinuationToken=function(a){var b=this;return this.ensureInitialised().then(function(c){return new Promise(function(c,d){var e=b._database.transaction([b._continuationTokenStore],"readonly"),f=e.objectStore(b._continuationTokenStore),g=IDBKeyRange.only(a),h=f.openCursor(g);h.onsuccess=function(a){var b=a.target.result;if(b){var d=b.value;c(d.continuationToken)}else c(null)},h.onerror=function(a){d({message:"Failed to openCursor: "+a.target.error.name})}})})},a.prototype.setContinuationToken=function(a,b){var c=this;return this.ensureInitialised().then(function(d){return new Promise(function(d,e){var f=c._database.transaction([c._continuationTokenStore],"readwrite"),g=f.objectStore(c._continuationTokenStore),h=g.put({continuationToken:b,conversationId:a});h.onerror=function(a){e({message:"add failed: "+a.target.error.name})},h.onsuccess=function(a){d(!0)}})})},a.prototype.addOrphanedEvent=function(a){var b=this;return this.ensureInitialised().then(function(c){return new Promise(function(c,d){var e=b._database.transaction([b._orphanedEventStore],"readwrite"),f=e.objectStore(b._orphanedEventStore),g=f.put(a);g.onerror=function(a){console.error("Error",a.target.error.name),d({message:"add failed: "+a.target.error.name})},g.onsuccess=function(a){c(!0)}})})},a.prototype.removeOrphanedEvent=function(a){var b=this;return this.ensureInitialised().then(function(c){return new Promise(function(c,d){var e=b._database.transaction([b._orphanedEventStore],"readwrite"),f=e.objectStore(b._orphanedEventStore),g=f.delete(a.eventId);g.onerror=function(a){d({message:"delete failed: "+a.target.error.name})},g.onsuccess=function(a){console.log("store.delete",a.target.result),c(!0)}})})},a.prototype.getOrphanedEvents=function(a){var b=this;return this.ensureInitialised().then(function(c){return new Promise(function(c,d){var e=b._database.transaction([b._orphanedEventStore],"readonly"),f=e.objectStore(b._orphanedEventStore),g=f.index("conversationId"),h=IDBKeyRange.only(a),i=[],j=g.openCursor(h,"prev");j.onsuccess=function(a){var b=a.target.result;b?(i.unshift(b.value),b.continue()):c(i.sort(function(a,b){return a.conversationEventId-b.conversationEventId}))},j.onerror=function(a){d({message:"Failed to openCursor: "+a.target.error.name})}})})},a.prototype.ensureInitialised=function(){return this._database?Promise.resolve(!0):this.initialise()},a.prototype.initialise=function(){var a=this;return new Promise(function(b,c){if(a.idbSupported){var d=a,e=indexedDB.open(a._name,a._version);e.onupgradeneeded=function(a){var b=a.target.result;if(b.objectStoreNames.contains(d._continuationTokenStore)||b.createObjectStore(d._continuationTokenStore,{keyPath:"conversationId"}),!b.objectStoreNames.contains(d._orphanedEventStore)){b.createObjectStore(d._orphanedEventStore,{keyPath:"eventId"}).createIndex("conversationId","conversationId",{unique:!1})}},e.onsuccess=function(c){a._database=c.target.result,b(!0)},e.onerror=function(a){c({message:"IndexedDBOrphanedEventManager.initialise failed : "+a.target.error.name})}}else c({message:"IndexedDBOrphanedEventManager not supported on this platform"})})},a.prototype.clearObjectStore=function(a){var b=this,c=a;return new Promise(function(a,d){var e=b._database.transaction([c],"readwrite");e.onerror=function(a){console.error("Transaction not opened due to error: "+e.error)};var f=e.objectStore(c),g=f.clear();g.onsuccess=function(b){a(!0)},g.onerror=function(a){d({message:"Failed to clear object store: "+a.target.error.name})}})},a.prototype.deleteTokenInfo=function(a){var b=this;return new Promise(function(c,d){var e=b._database.transaction([b._continuationTokenStore],"readwrite"),f=e.objectStore(b._continuationTokenStore),g=f.delete(a);g.onerror=function(a){d({message:"delete failed: "+a.target.error.name})},g.onsuccess=function(a){console.log("store.delete",a.target.result),c(!0)}})},a.prototype.deleteEvents=function(a){var b=this;return new Promise(function(c,d){var e=b._database.transaction([b._orphanedEventStore],"readwrite"),f=e.objectStore(b._orphanedEventStore),g=f.index("conversationId"),h=IDBKeyRange.only(a),i=g.openCursor(h,"next");i.onsuccess=function(a){var b=a.target.result;b?(f.delete(b.primaryKey),b.continue()):c(!0)},i.onerror=function(a){d({message:"Failed to openCursor: "+a.target.error.name})}})},a}();b.IndexedDBOrphanedEventManager=c},function(a,b){var c=function(){function a(a){this._localStorage=a,this._orphanedEevnts={},this._orphanedEevnts=this._localStorage.getObject("orphanedEevnts")||{}}return a.prototype.clearAll=function(){return this._orphanedEevnts={},this._localStorage.setObject("orphanedEevnts",this._orphanedEevnts),Promise.resolve(!0)},a.prototype.clear=function(a){return this._orphanedEevnts[a]={orphanedEvents:[]},this._localStorage.setObject("orphanedEevnts",this._orphanedEevnts),Promise.resolve(!0)},a.prototype.getContinuationToken=function(a){var b=this._orphanedEevnts[a];return Promise.resolve(b?b.continuationToken:null)},a.prototype.setContinuationToken=function(a,b){var c=this._orphanedEevnts[a];return c?c.continuationToken=b:this._orphanedEevnts[a]={continuationToken:b,orphanedEvents:[]},Promise.resolve(!0)},a.prototype.addOrphanedEvent=function(a){var b=this._orphanedEevnts[a.conversationId];if(!b)return Promise.reject({message:"No container for conversation "+a.conversationId});0===b.orphanedEvents.filter(function(b){return b.eventId===a.eventId}).length&&(b.orphanedEvents.unshift(a),b.orphanedEvents=b.orphanedEvents.sort(function(a,b){return a.conversationEventId>b.conversationEventId?1:a.conversationEventId<b.conversationEventId?-1:0}),this._localStorage.setObject("orphanedEevnts",this._orphanedEevnts))},a.prototype.removeOrphanedEvent=function(a){var b=this._orphanedEevnts[a.conversationId];if(b){for(var c=b.orphanedEvents.length-1;c>=0;c--){if(b.orphanedEvents[c].eventId===a.eventId){b.orphanedEvents.splice(c,1);break}}return this._localStorage.setObject("orphanedEevnts",this._orphanedEevnts),Promise.resolve(!0)}return Promise.reject({message:"No container for conversation "+a.conversationId})},a.prototype.getOrphanedEvents=function(a){var b=this._orphanedEevnts[a];return Promise.resolve(b?b.orphanedEvents:[])},a}();b.LocalStorageOrphanedEventManager=c},function(a,b,c){var d=c(1),e=c(23),f=function(){function a(){this.logRetentionHours=24,this.urlBase="https://api.comapi.com",this.webSocketBase="wss://api.comapi.com",this.logLevel=d.LogLevels.Error,this.logPersistence=d.LogPersistences.LocalStorage,this.isTypingTimeout=10,this.isTypingOffTimeout=10,this.foundationRestUrls=new e.FoundationRestUrls,this.apiSpaceId=void 0}return a.prototype.withApiSpace=function(a){return this.apiSpaceId=a,this},a.prototype.withLogRetentionTime=function(a){return this.logRetentionHours=a,this},a.prototype.withAuthChallenge=function(a){return this.authChallenge=a,this},a.prototype.withUrlBase=function(a){return this.urlBase=a,this},a.prototype.withWebSocketBase=function(a){return this.webSocketBase=a,this},a.prototype.withLogLevel=function(a){return this.logLevel=a,this},a.prototype.withLogPersistence=function(a){return this.logPersistence=a,this},a.prototype.withFoundationRestUrls=function(a){return this.foundationRestUrls=a,this},a}();b.ComapiConfig=f},function(a,b){var c=function(){function a(){this.conversations="{{urlBase}}/apispaces/{{apiSpaceId}}/conversations",this.conversation="{{urlBase}}/apispaces/{{apiSpaceId}}/conversations/{{conversationId}}",this.participants="{{urlBase}}/apispaces/{{apiSpaceId}}/conversations/{{conversationId}}/participants",this.typing="{{urlBase}}/apispaces/{{apiSpaceId}}/conversations/{{conversationId}}/typing",this.push="{{urlBase}}/apispaces/{{apiSpaceId}}/sessions/{{sessionId}}/push",this.facebook="{{urlBase}}/apispaces/{{apiSpaceId}}/channels/facebook/state",this.events="{{urlBase}}/apispaces/{{apiSpaceId}}/conversations/{{conversationId}}/events",this.messages="{{urlBase}}/apispaces/{{apiSpaceId}}/conversations/{{conversationId}}/messages",this.statusUpdates="{{urlBase}}/apispaces/{{apiSpaceId}}/conversations/{{conversationId}}/messages/statusupdates",this.profiles="{{urlBase}}/apispaces/{{apiSpaceId}}/profiles",this.profile="{{urlBase}}/apispaces/{{apiSpaceId}}/profiles/{{profileId}}",this.sessions="{{urlBase}}/apispaces/{{apiSpaceId}}/sessions",this.sessionStart="{{urlBase}}/apispaces/{{apiSpaceId}}/sessions/start",this.session="{{urlBase}}/apispaces/{{apiSpaceId}}/sessions/{{sessionId}}"}return a}();b.FoundationRestUrls=c},function(a,b){var c=function(){function a(a,b,c,d){this._networkManager=a,this._conversationManager=b,this._messageManager=c,this._messagePager=d}return a.prototype.createConversation=function(a){var b=this;return this._networkManager.ensureSessionAndSocket().then(function(c){return b._conversationManager.createConversation(a)})},a.prototype.updateConversation=function(a,b){var c=this;return this._networkManager.ensureSessionAndSocket().then(function(d){return c._conversationManager.updateConversation(a,b)})},a.prototype.getConversation=function(a){var b=this;return this._networkManager.ensureSessionAndSocket().then(function(c){return b._conversationManager.getConversation(a)})},a.prototype.deleteConversation=function(a){var b=this;return this._networkManager.ensureSessionAndSocket().then(function(c){return b._conversationManager.deleteConversation(a)}).then(function(c){return b._messagePager.resetConversation(a)})},a.prototype.addParticipantsToConversation=function(a,b){var c=this;return this._networkManager.ensureSessionAndSocket().then(function(d){return c._conversationManager.addParticipantsToConversation(a,b)})},a.prototype.deleteParticipantsFromConversation=function(a,b){var c=this;return this._networkManager.ensureSessionAndSocket().then(function(d){return c._conversationManager.deleteParticipantsFromConversation(a,b)})},a.prototype.getParticipantsInConversation=function(a){var b=this;return this._networkManager.ensureSessionAndSocket().then(function(c){return b._conversationManager.getParticipantsInConversation(a)})},a.prototype.getConversations=function(a,b){var c=this;return this._networkManager.ensureSessionAndSocket().then(function(d){return c._conversationManager.getConversations(a,b)})},a.prototype.getConversationEvents=function(a,b,c){var d=this;return this._networkManager.ensureSessionAndSocket().then(function(e){return d._messageManager.getConversationEvents(a,b,c)})},a.prototype.sendMessageToConversation=function(a,b){var c=this;return this._networkManager.ensureSessionAndSocket().then(function(d){return c._messageManager.sendMessageToConversation(a,b)})},a.prototype.sendMessageStatusUpdates=function(a,b){var c=this;return this._networkManager.ensureSessionAndSocket().then(function(d){return c._messageManager.sendMessageStatusUpdates(a,b)})},a.prototype.getMessages=function(a,b,c){var d,e,f=this;return this._networkManager.ensureSessionAndSocket().then(function(e){return d=e.session.profileId,f._messagePager.getMessages(a,b,c)}).then(function(b){return e=b,f._messagePager.markMessagesAsDelivered(a,b.messages,d)}).then(function(a){return Promise.resolve(e)})},a.prototype.sendIsTyping=function(a){var b=this;return this._networkManager.ensureSessionAndSocket().then(function(c){return b._conversationManager.sendIsTyping(a)})},a.prototype.sendIsTypingOff=function(a){var b=this;return this._networkManager.ensureSessionAndSocket().then(function(c){return b._conversationManager.sendIsTypingOff(a)})},a}();b.AppMessaging=c},function(a,b){var c=function(){function a(a,b,c){this._networkManager=a,this._localStorage=b,this._profileManager=c}return a.prototype.getProfile=function(a){var b=this;return this._networkManager.ensureSessionAndSocket().then(function(c){return b._profileManager.getProfile(a)})},a.prototype.queryProfiles=function(a){var b=this;return this._networkManager.ensureSessionAndSocket().then(function(c){return b._profileManager.queryProfiles(a)})},a.prototype.updateProfile=function(a,b,c){var d=this;return this._networkManager.ensureSessionAndSocket().then(function(e){return d._profileManager.updateProfile(a,b,c)})},a.prototype.patchProfile=function(a,b,c){var d=this;return this._networkManager.ensureSessionAndSocket().then(function(e){return d._profileManager.patchProfile(a,b,c)})},a.prototype.getMyProfile=function(a){var b=this;return void 0===a&&(a=!0),this._networkManager.ensureSessionAndSocket().then(function(a){return b._profileManager.getProfile(a.session.profileId)}).then(function(c){return a&&b._localStorage.setString("MyProfileETag",c.headers.ETag),Promise.resolve(c.response)})},a.prototype.updateMyProfile=function(a,b){var c=this;return void 0===b&&(b=!0),this._networkManager.ensureSessionAndSocket().then(function(d){return c._profileManager.updateProfile(d.session.profileId,a,b?c._localStorage.getString("MyProfileETag"):void 0)}).then(function(a){return b&&c._localStorage.setString("MyProfileETag",a.headers.ETag),Promise.resolve(a.response)})},a.prototype.patchMyProfile=function(a,b){var c=this;return this._networkManager.ensureSessionAndSocket().then(function(d){return c._profileManager.patchProfile(d.session.profileId,a,b?c._localStorage.getString("MyProfileETag"):void 0)}).then(function(a){return b&&c._localStorage.setString("MyProfileETag",a.headers.ETag),Promise.resolve(a.response)})},a}();b.Profile=c},function(a,b){var c=function(){function a(a,b){this._appMessaging=a,this._profile=b}return Object.defineProperty(a.prototype,"appMessaging",{get:function(){return this._appMessaging},enumerable:!0,configurable:!0}),Object.defineProperty(a.prototype,"profile",{get:function(){return this._profile},enumerable:!0,configurable:!0}),a}();b.Services=c},function(a,b){var c=function(){function a(a,b){this._networkManager=a,this._deviceManager=b}return a.prototype.setFCMPushDetails=function(a,b){var c=this;return this._networkManager.ensureSessionAndSocket().then(function(d){return c._deviceManager.setFCMPushDetails(d.session.id,a,b)})},a.prototype.setAPNSPushDetails=function(a,b,c){var d=this;return this._networkManager.ensureSessionAndSocket().then(function(e){return d._deviceManager.setAPNSPushDetails(e.session.id,a,b,c)})},a.prototype.removePushDetails=function(){var a=this;return this._networkManager.ensureSessionAndSocket().then(function(b){return a._deviceManager.removePushDetails(b.session.id)})},a}();b.Device=c},function(a,b){var c=function(){function a(a,b){this._networkManager=a,this._facebookManager=b}return a.prototype.createFbOptInState=function(a){var b=this;return this._networkManager.ensureSessionAndSocket().then(function(c){return b._facebookManager.createSendToMessengerState(a)})},a}();b.Channels=c},function(a,b){var c=function(){function a(a,b){this._sessionManager=a,this._webSocketManager=b}return a.prototype.startSession=function(){var a=this;return this._sessionManager.startSession().then(function(b){return a._webSocketManager.connect()}).then(function(b){return a._sessionManager.sessionInfo})},a.prototype.restartSession=function(){var a=this;return this._webSocketManager.disconnect().then(function(b){return a._sessionManager.startSession()}).then(function(b){return a._webSocketManager.connect()}).then(function(b){return a._sessionManager.sessionInfo})},Object.defineProperty(a.prototype,"session",{get:function(){return this._sessionManager.sessionInfo?this._sessionManager.sessionInfo.session:null},enumerable:!0,configurable:!0}),a.prototype.endSession=function(){var a=this;return this._webSocketManager.disconnect().then(function(){return a._sessionManager.endSession()})},a.prototype.getValidToken=function(){return this._sessionManager.getValidToken()},a.prototype.ensureSessionAndSocket=function(){var a=this;return this.ensureSession().then(function(b){return a.ensureSocket()}).then(function(b){return a._sessionManager.sessionInfo})},a.prototype.ensureSession=function(){return this._sessionManager.sessionInfo?Promise.resolve(this._sessionManager.sessionInfo):this._sessionManager.startSession()},a.prototype.ensureSocket=function(){return this._webSocketManager.hasSocket()?Promise.resolve(!0):this._webSocketManager.connect()},a}();b.NetworkManager=c}]);